<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OLDA | Production Master Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --apple-blue: #0071e3;
            --bg-primary: #f5f5f7;
            --bg-card: #FFFFFF;
            --text-primary: #1d1d1f;
            --text-secondary: #86868b;
            --border-light: #d2d2d7;
            --accent-dark: #1d1d1f;
            --accent-danger: #ff3b30;
            --radius-md: 12px;
            --radius-lg: 18px;
            --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
        }

        * { box-sizing: border-box; -webkit-font-smoothing: antialiased; }

        body {
            margin: 0;
            padding: 0;
            background: var(--bg-primary);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            color: var(--text-primary);
        }

        /* Header Fixe et propre */
        .app-header {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-light);
            padding: 12px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .logo { font-size: 17px; font-weight: 700; letter-spacing: -0.5px; }
        .logo span { color: var(--text-secondary); font-weight: 400; }

        .app-container {
            display: flex;
            flex-direction: column; /* Stack sur mobile par défaut */
            min-height: calc(100vh - 60px);
        }

        @media (min-width: 900px) {
            .app-container { flex-direction: row; }
        }

        /* Sidebar - Collection */
        .sidebar {
            width: 100%;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-light);
            padding: 20px;
        }

        @media (min-width: 900px) {
            .sidebar { width: 280px; border-right: 1px solid var(--border-light); border-bottom: none; }
        }

        .collection-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-radius: var(--radius-md);
            background: var(--bg-primary);
            font-weight: 600;
            cursor: pointer;
        }

        .collection-item.active { background: var(--accent-dark); color: white; }

        /* Main Area */
        .main-content {
            flex: 1;
            padding: 15px;
            max-width: 100%;
            overflow-x: hidden;
        }

        @media (min-width: 768px) { .main-content { padding: 30px; } }

        /* Tabs Style Apple */
        .tabs-header {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding-bottom: 5px;
            scrollbar-width: none;
        }

        .tab-item {
            background: white;
            padding: 10px 20px;
            border-radius: 10px;
            border: 1px solid var(--border-light);
            font-size: 13px;
            font-weight: 500;
            white-space: nowrap;
            cursor: pointer;
            transition: 0.2s;
        }

        .tab-item.active { border-color: var(--apple-blue); color: var(--apple-blue); box-shadow: 0 2px 8px rgba(0,113,227,0.1); }

        /* Card Master */
        .production-card {
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            margin: 0 auto;
            max-width: 600px;
            width: 100%;
            overflow: hidden;
        }

        /* Stepper High-End */
        .stepper-container {
            padding: 30px 20px;
            background: #fafafa;
            border-bottom: 1px solid var(--border-light);
        }

        .stepper { display: flex; justify-content: space-between; position: relative; }

        .stepper::before {
            content: '';
            position: absolute;
            top: 15px; left: 0; right: 0;
            height: 2px; background: #e5e5e5;
            z-index: 1;
        }

        .stepper-progress {
            position: absolute; top: 15px; left: 0;
            height: 2px; background: var(--apple-blue);
            z-index: 2; transition: width 0.4s ease;
        }

        .step { position: relative; z-index: 3; text-align: center; flex: 1; cursor: pointer; }

        .step-circle {
            width: 30px; height: 30px;
            background: white; border: 2px solid #e5e5e5;
            border-radius: 50%; margin: 0 auto 8px;
            display: flex; align-items: center; justify-content: center;
            font-size: 12px; font-weight: 700; transition: 0.3s;
        }

        .step.active .step-circle { border-color: var(--apple-blue); color: var(--apple-blue); transform: scale(1.1); background: white; }
        .step.completed .step-circle { background: var(--apple-blue); border-color: var(--apple-blue); color: white; }
        
        .step-label { font-size: 10px; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; }
        .step.active .step-label { color: var(--text-primary); }

        /* Form & Inputs */
        .card-content { padding: 25px; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        @media (max-width: 480px) { .form-grid { grid-template-columns: 1fr; } }

        .form-group label { display: block; font-size: 11px; font-weight: 700; text-transform: uppercase; color: var(--text-secondary); margin-bottom: 6px; }

        .form-input, .form-select {
            width: 100%; height: 44px; padding: 0 12px;
            border: 1px solid var(--border-light); border-radius: 10px;
            font-size: 15px; background: #fdfdfd; outline: none; transition: 0.2s;
        }

        .form-input:focus { border-color: var(--apple-blue); background: white; }

        /* Canvas Box Apple Style */
        .canvas-container {
            background: #f5f5f7;
            border-radius: 14px;
            padding: 20px;
            display: flex;
            justify-content: center;
            margin-top: 15px;
        }

        .canvas-box { position: relative; width: 280px; height: 330px; background: white; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }

        /* Actions Footer */
        .card-footer { padding: 20px 25px; border-top: 1px solid var(--border-light); background: #fafafa; }
        .generate-btn {
            width: 100%; padding: 16px; border-radius: 12px;
            background: var(--accent-dark); color: white;
            font-weight: 700; border: none; cursor: pointer; transition: 0.2s;
        }
        .generate-btn:hover { opacity: 0.9; transform: translateY(-1px); }

        /* Utility classes */
        .urgent-mode { border: 2px solid var(--accent-danger) !important; box-shadow: 0 0 20px rgba(255,59,48,0.1) !important; }
        .hidden { display: none; }
    </style>
</head>
<body>

<header class="app-header">
    <div class="logo">OLDA <span>Production</span></div>
    <div class="header-actions">
        <button class="header-btn-ghost" style="background:none; border:none; color:var(--apple-blue); font-weight:600; cursor:pointer;" onclick="App.saveToStorage()">Enregistrer</button>
        <button class="header-btn-primary" style="background:var(--accent-dark); color:white; border:none; padding:8px 16px; border-radius:8px; font-weight:600; margin-left:10px; cursor:pointer;" onclick="App.addTab()">+ Nouvelle Fiche</button>
    </div>
</header>

<div class="app-container">
    <aside class="sidebar">
        <div style="font-size:11px; font-weight:700; color:var(--text-secondary); margin-bottom:15px; letter-spacing:1px;">COLLECTIONS</div>
        <div class="collection-item active">
            <div style="width:30px; height:30px; background:rgba(255,255,255,0.2); border-radius:6px; display:flex; align-items:center; justify-content:center; margin-right:12px;">T</div>
            <span>T-Shirts</span>
            <span id="countTshirts" style="margin-left:auto; opacity:0.7; font-size:12px;">0</span>
        </div>
    </aside>

    <main class="main-content">
        <div class="tabs-header" id="tabsHeader">
            <div class="tab-item" onclick="App.addTab()" style="border:1px dashed var(--border-light);">+ Nouveau</div>
        </div>

        <div class="production-card" id="productionCard">
            <div class="stepper-container">
                <div class="stepper">
                    <div class="stepper-progress" id="stepperProgress" style="width: 0%"></div>
                    <div class="step active" data-step="1" onclick="App.setStep(1)">
                        <div class="step-circle">1</div>
                        <div class="step-label">Saisie</div>
                    </div>
                    <div class="step" data-step="2" onclick="App.setStep(2)">
                        <div class="step-circle">2</div>
                        <div class="step-label">Prép.</div>
                    </div>
                    <div class="step" data-step="3" onclick="App.setStep(3)">
                        <div class="step-circle">3</div>
                        <div class="step-label">Prod.</div>
                    </div>
                    <div class="step" data-step="4" onclick="App.setStep(4)">
                        <div class="step-circle">4</div>
                        <div class="step-label">Fin</div>
                    </div>
                </div>
            </div>

            <div class="card-content" id="capture">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h2 style="font-size:18px; margin:0;">Fiche de Production</h2>
                    <button id="urgentBtn" onclick="App.toggleUrgent()" style="padding:6px 12px; border-radius:20px; border:1px solid var(--border-light); background:white; font-size:10px; font-weight:800; cursor:pointer;">URGENT</button>
                </div>

                <div style="background:var(--bg-primary); padding:15px; border-radius:12px; display:flex; align-items:center; gap:15px; margin-bottom:20px;">
                    <div style="flex:1;">
                        <label style="font-size:10px; font-weight:700; color:var(--text-secondary); display:block; margin-bottom:4px;">LIVRAISON PRÉVUE</label>
                        <input type="date" id="deadlineInput" onchange="App.updateDeadline()" style="background:none; border:none; font-weight:700; font-size:16px; outline:none; color:var(--text-primary);">
                    </div>
                    <div id="deadlineBadge" style="padding:6px 12px; border-radius:8px; background:var(--accent-dark); color:white; font-size:11px; font-weight:700;">-</div>
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label>Client</label>
                        <input type="text" id="custName" class="form-input" placeholder="Ex: Jean Dupont" oninput="App.updateTabName()">
                    </div>
                    <div class="form-group">
                        <label>Téléphone</label>
                        <input type="tel" id="custTel" class="form-input" placeholder="06 ...">
                    </div>
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label>Référence</label>
                        <select id="refSelect" class="form-select" onchange="App.checkManual()"></select>
                    </div>
                    <div class="form-group">
                        <label>Taille</label>
                        <select id="sizeSelect" class="form-select">
                            <option>XS</option><option>S</option><option selected>M</option><option>L</option><option>XL</option><option>XXL</option>
                        </select>
                    </div>
                </div>

                <div id="manualZone" class="hidden" style="margin-bottom: 20px;">
                    <input type="text" id="manualRef" class="form-input" placeholder="Saisir référence manuelle...">
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label>Couleur T-Shirt</label>
                        <select id="tsColorSelect" class="form-select" onchange="App.updateTsColor()">
                            <option value="#FFFFFF">Blanc</option><option value="#1A1A1A">Noir</option><option value="#D3D3D3">Gris</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Couleur Logo</label>
                        <select id="logoColorSelect" class="form-select" onchange="App.updateLogoColor()">
                            <option value="#000000">Noir</option><option value="#FFFFFF">Blanc</option><option value="#EF4444">Rouge</option>
                        </select>
                    </div>
                </div>

                <div style="margin-top:20px;">
                    <div style="display:flex; gap:10px; margin-bottom:10px;">
                        <button onclick="App.toggleView('AV')" id="btnAV" style="flex:1; padding:10px; border-radius:8px; border:1px solid var(--border-light); background:white; font-size:11px; font-weight:700; cursor:pointer;">AVANT</button>
                        <button onclick="App.toggleView('AR')" id="btnAR" style="flex:1; padding:10px; border-radius:8px; border:1px solid var(--border-light); background:white; font-size:11px; font-weight:700; cursor:pointer;">ARRIÈRE</button>
                    </div>

                    <div id="zoneAV" class="canvas-container hidden">
                        <div class="canvas-box">
                            <svg style="position:absolute; width:100%; height:100%; pointer-events:none; z-index:1;" viewBox="0 0 280 330">
                                <path id="pathAV" d="M 93,23 L 65,33 L 14,65 L 33,108 L 51,94 L 51,300 L 229,300 L 229,94 L 247,108 L 266,65 L 215,33 L 187,23 C 178,42 150,52 140,52 C 130,52 102,42 93,23 Z" fill="#FFFFFF" stroke="#E5E7EB" stroke-width="1.5"/>
                            </svg>
                            <canvas id="canAV" style="z-index:2; position:relative;"></canvas>
                        </div>
                    </div>
                    <div id="zoneAR" class="canvas-container hidden">
                        <div class="canvas-box">
                            <svg style="position:absolute; width:100%; height:100%; pointer-events:none; z-index:1;" viewBox="0 0 280 330">
                                <path id="pathAR" d="M 93,23 L 65,33 L 14,65 L 33,108 L 51,94 L 51,300 L 229,300 L 229,94 L 247,108 L 266,65 L 215,33 L 187,23 C 182,28 165,33 140,33 C 115,33 98,28 93,23 Z" fill="#FFFFFF" stroke="#E5E7EB" stroke-width="1.5"/>
                            </svg>
                            <canvas id="canAR" style="z-index:2; position:relative;"></canvas>
                        </div>
                    </div>

                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;">
                        <label for="fileInputAV" style="background:#f5f5f7; padding:10px; text-align:center; border-radius:8px; font-size:11px; font-weight:600; cursor:pointer;">+ Image Avant</label>
                        <label for="fileInputAR" style="background:#f5f5f7; padding:10px; text-align:center; border-radius:8px; font-size:11px; font-weight:600; cursor:pointer;">+ Image Arrière</label>
                    </div>
                    <input type="file" id="fileInputAV" class="hidden" accept="image/*" onchange="App.handleUpload('AV', event)">
                    <input type="file" id="fileInputAR" class="hidden" accept="image/*" onchange="App.handleUpload('AR', event)">
                </div>
            </div>

            <div class="card-footer">
                <div style="display:flex; justify-content:space-between; margin-bottom:15px; font-weight:700; font-size:18px;">
                    <span>Total</span>
                    <span id="displayTotal">0 EUR</span>
                </div>
                <button class="generate-btn" id="finalGenBtn" onclick="App.generatePdf()">VALIDER ET GÉNÉRER PDF</button>
            </div>
        </div>
    </main>
</div>

<div id="pdfModal" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:2000; display:none; flex-direction:column;">
    <div style="padding:20px; display:flex; justify-content:space-between; background:white;">
        <span style="font-weight:700;">Aperçu de la fiche</span>
        <button onclick="App.closePdfModal()" style="border:none; background:none; font-weight:700; color:red;">Fermer</button>
    </div>
    <div style="flex:1; overflow:auto; display:flex; align-items:center; justify-content:center; padding:20px;">
        <img id="pdfPreviewImg" style="max-width:100%; box-shadow:0 10px 30px rgba(0,0,0,0.5);">
    </div>
</div>

<script>
// Votre logique métier (Script URL et App Object)
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxTHi761jWpYHrLYeEtUnbQMqg982eb8Y6p9EnrprARTYW-OuRM8zQQ30fCwZwuW5Wm/exec";

const App = {
    state: { currentTab: 1, nextId: 2, tabs: {}, cans: { AV: null, AR: null }, step: 1, isUrgent: false },

    init() {
        this.cans = {
            AV: new fabric.Canvas('canAV', { width: 280, height: 330 }),
            AR: new fabric.Canvas('canAR', { width: 280, height: 330 })
        };
        this.updateRefList();
        this.initDeadline();
        this.renderTabs();
        this.setStep(1);
    },

    setStep(step) {
        this.state.step = step;
        document.querySelectorAll('.step').forEach((s, i) => {
            s.classList.toggle('active', i + 1 === step);
            s.classList.toggle('completed', i + 1 < step);
        });
        document.getElementById('stepperProgress').style.width = ((step - 1) / 3 * 100) + '%';
    },

    toggleUrgent() {
        this.state.isUrgent = !this.state.isUrgent;
        document.getElementById('productionCard').classList.toggle('urgent-mode', this.state.isUrgent);
        document.getElementById('urgentBtn').style.background = this.state.isUrgent ? '#ff3b30' : 'white';
        document.getElementById('urgentBtn').style.color = this.state.isUrgent ? 'white' : 'black';
    },

    updateRefList() {
        const s = document.getElementById('refSelect'); s.innerHTML = '';
        for(let i=1; i<=10; i++) s.innerHTML += `<option>TS-${i.toString().padStart(3,'0')}</option>`;
        s.innerHTML += `<option>MANUEL</option>`;
    },

    checkManual() {
        const isMan = document.getElementById('refSelect').value === 'MANUEL';
        document.getElementById('manualZone').classList.toggle('hidden', !isMan);
    },

    initDeadline() {
        const d = new Date(); d.setDate(d.getDate() + 7);
        document.getElementById('deadlineInput').value = d.toISOString().split('T')[0];
        this.updateDeadline();
    },

    updateDeadline() {
        const val = document.getElementById('deadlineInput').value;
        const diff = Math.ceil((new Date(val) - new Date()) / (1000*60*60*24));
        const badge = document.getElementById('deadlineBadge');
        badge.textContent = diff + "j";
        badge.style.background = diff <= 2 ? '#ff3b30' : '#1d1d1f';
    },

    toggleView(side) {
        document.getElementById('zoneAV').classList.add('hidden');
        document.getElementById('zoneAR').classList.add('hidden');
        document.getElementById('zone'+side).classList.remove('hidden');
        document.getElementById('btnAV').style.background = 'white';
        document.getElementById('btnAR').style.background = 'white';
        document.getElementById('btn'+side).style.background = '#f5f5f7';
    },

    handleUpload(side, e) {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = (f) => {
            fabric.Image.fromURL(f.target.result, (img) => {
                img.scaleToWidth(150);
                this.cans[side].add(img).centerObject(img).setActiveObject(img);
                this.toggleView(side);
            });
        };
        reader.readAsDataURL(file);
    },

    updateTsColor() {
        const c = document.getElementById('tsColorSelect').value;
        document.getElementById('pathAV').setAttribute('fill', c);
        document.getElementById('pathAR').setAttribute('fill', c);
    },

    updateTabName() {
        const name = document.getElementById('custName').value || 'Nouveau';
        // Logique simplifiée pour rafraichir le nom de l'onglet
    },

    generatePdf() {
        const btn = document.getElementById('finalGenBtn');
        btn.innerText = "Génération...";
        html2canvas(document.getElementById('capture')).then(canvas => {
            const imgData = canvas.toDataURL('image/png');
            document.getElementById('pdfPreviewImg').src = imgData;
            document.getElementById('pdfModal').style.display = 'flex';
            btn.innerText = "VALIDER ET GÉNÉRER PDF";
            this.setStep(4);
        });
    },

    closePdfModal() { document.getElementById('pdfModal').style.display = 'none'; }
};

window.onload = () => App.init();
</script>
</body>
</html>
