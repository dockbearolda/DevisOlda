<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OLDA | Production Master</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        :root { --apple-blue: #007AFF; --apple-red: #FF3B30; --bg: #F5F7FA; }
        body { background-color: var(--bg); font-family: 'Inter', sans-serif; display: flex; flex-direction: column; align-items: center; padding: 10px; color: #1d1d1f; }
        
        .main-card { width: 100%; max-width: 500px; background: #fff; border-radius: 30px; padding: 20px; box-shadow: 0 15px 40px rgba(0,0,0,0.08); box-sizing: border-box; }
        
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; align-items: end; }
        .label { font-size: 10px; font-weight: 800; color: #86868B; text-transform: uppercase; margin-bottom: 5px; display: flex; align-items: center; gap: 5px; }
        
        .mini-check { width: 16px; height: 16px; accent-color: var(--apple-blue); margin: 0; }
        .input-apple, .select-apple { width: 100%; height: 42px; padding: 0 10px; border-radius: 10px; border: 1px solid #EFEEF2; font-size: 12px; font-weight: 600; background: #FBFBFD; outline: none; box-sizing: border-box; }

        .target-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; margin-bottom: 12px; }
        .chip { padding: 8px 0; background: #F2F2F7; border-radius: 8px; font-size: 9px; font-weight: 800; text-align: center; cursor: pointer; }
        .chip.active { background: #000; color: #fff; }

        /* Preview Layout */
        .view-section { margin-top: 15px; display: none; }
        .view-section.visible { display: block; }
        
        .canvas-box { width: 300px; height: 350px; background: linear-gradient(145deg, #fafafa 0%, #f0f0f0 100%); border-radius: 20px; position: relative; border: 1px solid #E8E8E8; margin: 10px auto; overflow: hidden; box-shadow: inset 0 2px 8px rgba(0,0,0,0.04); }
        .tshirt-svg { position: absolute; width: 300px; height: 350px; top: 0; left: 0; z-index: 1; pointer-events: none; }
        .tshirt-svg path.tshirt-body { filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1)); }
        canvas { z-index: 2; }

        .footer { display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #EEE; padding-top: 15px; margin-top: 10px; }
        .btn-confirm { background: #000; color: white; border: none; padding: 18px; border-radius: 15px; font-weight: 800; width: 100%; margin-top: 15px; }
    </style>
</head>
<body>

<div class="main-card" id="capture">
    <div class="grid-2">
        <div><span class="label">Client</span><input type="text" id="custName" class="input-apple" placeholder="Nom"></div>
        <div><span class="label">T√©l√©phone</span><input type="tel" id="custTel" class="input-apple" placeholder="06.."></div>
    </div>

    <div class="target-grid">
        <div class="chip active" onclick="App.setTarget('H', this)">Homme</div>
        <div class="chip" onclick="App.setTarget('F', this)">Femme</div>
        <div class="chip" onclick="App.setTarget('E', this)">Enfant</div>
        <div class="chip" onclick="App.setTarget('B', this)">B√©b√©</div>
    </div>

    <div class="grid-2">
        <div><span class="label">R√©f√©rence</span><select id="refSelect" class="select-apple"></select></div>
        <div><span class="label">Taille</span>
            <select id="sizeSelect" class="select-apple">
                <option>XS</option><option>S</option><option selected>M</option><option>L</option><option>XL</option><option>XXL</option>
            </select>
        </div>
    </div>

    <div class="grid-2">
        <div>
            <span class="label">Manuel <input type="checkbox" id="manualCheck" class="mini-check" onchange="App.toggleManual()"></span>
            <input type="text" id="manualRef" class="input-apple" placeholder="..." disabled>
        </div>
        <div style="height: 42px; display: flex; align-items: center; justify-content: center; gap: 15px; background: #FBFBFD; border-radius: 10px; border: 1px solid #EFEEF2;">
            <label class="label" style="margin:0"><input type="checkbox" id="checkAV" class="mini-check" onchange="App.toggleView('AV')"> AV</label>
            <label class="label" style="margin:0"><input type="checkbox" id="checkAR" class="mini-check" onchange="App.toggleView('AR')"> AR</label>
        </div>
    </div>

    <div class="grid-2">
        <div><span class="label">Couleur T-Shirt (Pastel)</span>
            <select id="tsColorSelect" class="select-apple" onchange="App.updateTsColor()">
                <option value="#FFFFFF">Blanc Pure</option>
                <option value="#1A1A1A">Noir Deep</option>
                <option value="#FDFD96">Jaune Pastel</option>
                <option value="#FFD1DC">Rose Pastel</option>
                <option value="#B3E5FC">Bleu Ciel</option>
                <option value="#C1E1C1">Vert Menthe</option>
                <option value="#E6E6FA">Lavande</option>
                <option value="#FFDAB9">P√™che</option>
                <option value="#F5F5DC">Beige</option>
                <option value="#B0E0E6">Bleu Poudr√©</option>
                <option value="#F08080">Corail Douce</option>
                <option value="#D3D3D3">Gris Clair</option>
                <option value="#FAF0E6">Lin</option>
                <option value="#FFF5EE">Coquillage</option>
                <option value="#F0FFFF">Azure</option>
            </select>
        </div>
        <div><span class="label">Couleur Logo (16)</span>
            <select id="logoColorSelect" class="select-apple" onchange="App.updateLogoColor()">
                <option value="#000000">Noir</option>
                <option value="#FFFFFF">Blanc</option>
                <option value="#FF3B30">Rouge Apple</option>
                <option value="#007AFF">Bleu Apple</option>
                <option value="#34C759">Vert Apple</option>
                <option value="#FFCC00">Or / Jaune</option>
                <option value="#AF52DE">Violet</option>
                <option value="#5856D6">Indigo</option>
                <option value="#FF9500">Orange</option>
                <option value="#A2845E">Bronze</option>
                <option value="#8E8E93">Gris</option>
                <option value="#C0C0C0">Argent</option>
                <option value="#FF2D55">Rose Flash</option>
                <option value="#5AC8FA">Bleu Cyan</option>
                <option value="#000080">Marine</option>
                <option value="#556B2F">Olive</option>
            </select>
        </div>
    </div>

    <div id="zoneAV" class="view-section">
        <span class="label">Logo AVANT</span>
        <select id="logoAV" class="select-apple" onchange="App.triggerFile('AV')">
            <option value="">-- Choisir logo AV --</option>
            <option value="UPLOAD">üìÅ Parcourir...</option>
            <option value="BEA-16">BEA-16</option>
            <option value="SXM-12">SXM-12</option>
            <option value="WRA-01">WRA-01</option>
            <option value="VIN-01">VIN-01</option>
        </select>
        <div class="canvas-box">
            <svg class="tshirt-svg" viewBox="0 0 300 350">
                <defs>
                    <linearGradient id="fabricGradientAV" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:rgba(255,255,255,0.15)"/>
                        <stop offset="50%" style="stop-color:rgba(0,0,0,0)"/>
                        <stop offset="100%" style="stop-color:rgba(0,0,0,0.08)"/>
                    </linearGradient>
                    <linearGradient id="sleeveShadeAV" x1="0%" y1="0%" x2="100%" y2="0%">
                        <stop offset="0%" style="stop-color:rgba(0,0,0,0.12)"/>
                        <stop offset="100%" style="stop-color:rgba(0,0,0,0)"/>
                    </linearGradient>
                    <filter id="fabricTextureAV" x="0%" y="0%" width="100%" height="100%">
                        <feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="4" result="noise"/>
                        <feDiffuseLighting in="noise" lighting-color="white" surfaceScale="1" result="light">
                            <feDistantLight azimuth="45" elevation="60"/>
                        </feDiffuseLighting>
                        <feBlend in="SourceGraphic" in2="light" mode="multiply"/>
                    </filter>
                </defs>
                <!-- Corps principal du t-shirt -->
                <path class="tshirt-body" id="pathAV" d="M50,35
                    Q70,28 110,18
                    C125,15 135,22 150,28
                    C165,22 175,15 190,18
                    Q230,28 250,35
                    L295,85
                    Q285,95 265,108
                    L250,98
                    Q248,105 248,115
                    L248,335
                    Q248,342 240,342
                    L60,342
                    Q52,342 52,335
                    L52,115
                    Q52,105 50,98
                    L35,108
                    Q15,95 5,85
                    Z" fill="#FFFFFF" stroke="#E0E0E0" stroke-width="1.5"/>
                <!-- Overlay texture tissu -->
                <path d="M50,35 Q70,28 110,18 C125,15 135,22 150,28 C165,22 175,15 190,18 Q230,28 250,35 L295,85 Q285,95 265,108 L250,98 Q248,105 248,115 L248,335 Q248,342 240,342 L60,342 Q52,342 52,335 L52,115 Q52,105 50,98 L35,108 Q15,95 5,85 Z" fill="url(#fabricGradientAV)" opacity="0.6"/>
                <!-- Col en V/rond d√©taill√© -->
                <path d="M110,18 C125,15 135,25 150,32 C165,25 175,15 190,18" fill="none" stroke="#D0D0D0" stroke-width="2.5" stroke-linecap="round"/>
                <path d="M112,21 C127,18 137,27 150,33 C163,27 173,18 188,21" fill="none" stroke="#E8E8E8" stroke-width="1"/>
                <!-- Coutures √©paules -->
                <line x1="110" y1="18" x2="52" y2="100" stroke="#E5E5E5" stroke-width="1" stroke-dasharray="3,2"/>
                <line x1="190" y1="18" x2="248" y2="100" stroke="#E5E5E5" stroke-width="1" stroke-dasharray="3,2"/>
                <!-- Coutures manches -->
                <path d="M52,100 Q45,85 35,108" fill="none" stroke="#E5E5E5" stroke-width="1"/>
                <path d="M248,100 Q255,85 265,108" fill="none" stroke="#E5E5E5" stroke-width="1"/>
                <!-- Ourlet bas -->
                <line x1="60" y1="338" x2="240" y2="338" stroke="#E0E0E0" stroke-width="1.5"/>
                <line x1="62" y1="335" x2="238" y2="335" stroke="#EFEFEF" stroke-width="0.5"/>
                <!-- Coutures c√¥t√©s -->
                <line x1="55" y1="115" x2="55" y2="335" stroke="#EBEBEB" stroke-width="0.8"/>
                <line x1="245" y1="115" x2="245" y2="335" stroke="#EBEBEB" stroke-width="0.8"/>
                <!-- Ombrage subtil manches -->
                <path d="M50,35 L5,85 L35,108 L50,98 Z" fill="url(#sleeveShadeAV)" opacity="0.3"/>
                <path d="M250,35 L295,85 L265,108 L250,98 Z" fill="url(#sleeveShadeAV)" opacity="0.3" transform="scale(-1,1) translate(-300,0)"/>
            </svg>
            <canvas id="canAV"></canvas>
        </div>
    </div>

    <div id="zoneAR" class="view-section">
        <span class="label">Logo ARRI√àRE</span>
        <select id="logoAR" class="select-apple" onchange="App.triggerFile('AR')">
            <option value="">-- Choisir logo AR --</option>
            <option value="UPLOAD">üìÅ Parcourir...</option>
            <option value="BEA-16">BEA-16</option>
            <option value="SXM-12">SXM-12</option>
            <option value="WRA-01">WRA-01</option>
            <option value="VIN-01">VIN-01</option>
        </select>
        <div class="canvas-box">
            <svg class="tshirt-svg" viewBox="0 0 300 350">
                <defs>
                    <linearGradient id="fabricGradientAR" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:rgba(255,255,255,0.12)"/>
                        <stop offset="50%" style="stop-color:rgba(0,0,0,0)"/>
                        <stop offset="100%" style="stop-color:rgba(0,0,0,0.1)"/>
                    </linearGradient>
                    <linearGradient id="sleeveShadeAR" x1="0%" y1="0%" x2="100%" y2="0%">
                        <stop offset="0%" style="stop-color:rgba(0,0,0,0.12)"/>
                        <stop offset="100%" style="stop-color:rgba(0,0,0,0)"/>
                    </linearGradient>
                </defs>
                <!-- Corps principal du t-shirt (vue arri√®re) -->
                <path class="tshirt-body" id="pathAR" d="M50,35
                    Q70,28 110,18
                    C130,15 145,18 150,20
                    C155,18 170,15 190,18
                    Q230,28 250,35
                    L295,85
                    Q285,95 265,108
                    L250,98
                    Q248,105 248,115
                    L248,335
                    Q248,342 240,342
                    L60,342
                    Q52,342 52,335
                    L52,115
                    Q52,105 50,98
                    L35,108
                    Q15,95 5,85
                    Z" fill="#FFFFFF" stroke="#E0E0E0" stroke-width="1.5"/>
                <!-- Overlay texture tissu -->
                <path d="M50,35 Q70,28 110,18 C130,15 145,18 150,20 C155,18 170,15 190,18 Q230,28 250,35 L295,85 Q285,95 265,108 L250,98 Q248,105 248,115 L248,335 Q248,342 240,342 L60,342 Q52,342 52,335 L52,115 Q52,105 50,98 L35,108 Q15,95 5,85 Z" fill="url(#fabricGradientAR)" opacity="0.6"/>
                <!-- Col arri√®re (plus plat) -->
                <path d="M110,18 C130,14 145,17 150,19 C155,17 170,14 190,18" fill="none" stroke="#D0D0D0" stroke-width="2.5" stroke-linecap="round"/>
                <path d="M112,21 C132,17 147,19 150,20 C153,19 168,17 188,21" fill="none" stroke="#E8E8E8" stroke-width="1"/>
                <!-- Couture centrale dos (caract√©ristique vue arri√®re) -->
                <line x1="150" y1="25" x2="150" y2="335" stroke="#F0F0F0" stroke-width="0.8" stroke-dasharray="8,4"/>
                <!-- Coutures √©paules -->
                <line x1="110" y1="18" x2="52" y2="100" stroke="#E5E5E5" stroke-width="1" stroke-dasharray="3,2"/>
                <line x1="190" y1="18" x2="248" y2="100" stroke="#E5E5E5" stroke-width="1" stroke-dasharray="3,2"/>
                <!-- Coutures manches -->
                <path d="M52,100 Q45,85 35,108" fill="none" stroke="#E5E5E5" stroke-width="1"/>
                <path d="M248,100 Q255,85 265,108" fill="none" stroke="#E5E5E5" stroke-width="1"/>
                <!-- Ourlet bas -->
                <line x1="60" y1="338" x2="240" y2="338" stroke="#E0E0E0" stroke-width="1.5"/>
                <line x1="62" y1="335" x2="238" y2="335" stroke="#EFEFEF" stroke-width="0.5"/>
                <!-- Coutures c√¥t√©s -->
                <line x1="55" y1="115" x2="55" y2="335" stroke="#EBEBEB" stroke-width="0.8"/>
                <line x1="245" y1="115" x2="245" y2="335" stroke="#EBEBEB" stroke-width="0.8"/>
                <!-- Ombrage subtil manches -->
                <path d="M50,35 L5,85 L35,108 L50,98 Z" fill="url(#sleeveShadeAR)" opacity="0.3"/>
                <path d="M250,35 L295,85 L265,108 L250,98 Z" fill="url(#sleeveShadeAR)" opacity="0.3" transform="scale(-1,1) translate(-300,0)"/>
                <!-- √âtiquette col (typique vue arri√®re) -->
                <rect x="140" y="22" width="20" height="8" fill="#F5F5F5" stroke="#E0E0E0" stroke-width="0.5" rx="1"/>
            </svg>
            <canvas id="canAR"></canvas>
        </div>
    </div>

    <div class="footer">
        <div style="font-size: 22px; font-weight: 900;"><input type="number" id="priceInput" value="25" style="border:none; width:60px; font-size:22px; font-weight:900;">‚Ç¨</div>
        <div class="label" style="margin:0">
            <label><input type="checkbox" class="mini-check"> CASH</label>
            <label style="color:#34C759; margin-left:10px;"><input type="checkbox" class="mini-check"> R√âGL√â</label>
        </div>
    </div>
</div>

<button class="btn-confirm" onclick="App.download()">EXP√âDIER LA FICHE PNG</button>
<input type="file" id="fileInput" style="display:none" accept="image/jpeg,image/jpg,image/png,image/gif,image/svg+xml,image/webp,image/bmp,image/tiff,application/pdf,.jpg,.jpeg,.png,.gif,.svg,.webp,.bmp,.tiff,.tif,.pdf">

<script>
const App = {
    state: { currentSide: 'AV', targetPrefix: 'H', cans: { AV: null, AR: null } },
    init() { 
        this.state.cans.AV = this.setupCanvas('canAV');
        this.state.cans.AR = this.setupCanvas('canAR');
        this.updateRefList();
        
        fabric.Object.prototype.controls.deleteControl = new fabric.Control({
            x: 0.5, y: -0.5, offsetY: -16, offsetX: 16, cursorStyle: 'pointer',
            mouseUpHandler: (e, t) => { t.target.canvas.remove(t.target); t.target.canvas.requestRenderAll(); },
            render: (ctx, l, t) => {
                ctx.save(); ctx.translate(l, t); ctx.beginPath(); ctx.arc(0, 0, 12, 0, 2*Math.PI);
                ctx.fillStyle = "#FF3B30"; ctx.fill(); ctx.strokeStyle="white"; ctx.lineWidth=2;
                ctx.moveTo(-5,-5); ctx.lineTo(5,5); ctx.moveTo(5,-5); ctx.lineTo(-5,5); ctx.stroke(); ctx.restore();
            }
        });

        document.getElementById('fileInput').addEventListener('change', (e) => this.handleFile(e));
    },
    setupCanvas(id) {
        const c = new fabric.Canvas(id, { width: 300, height: 350 });
        c.on('object:scaling', (e) => e.target.set({ scaleY: e.target.scaleX }));
        return c;
    },
    toggleView(side) {
        const isChecked = document.getElementById('check'+side).checked;
        document.getElementById('zone'+side).classList.toggle('visible', isChecked);
    },
    setTarget(prefix, el) {
        this.state.targetPrefix = prefix;
        document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
        el.classList.add('active'); this.updateRefList();
    },
    updateRefList() {
        const s = document.getElementById('refSelect'); s.innerHTML = "";
        for(let i=1; i<=15; i++) {
            let v = this.state.targetPrefix + i.toString().padStart(3, '0');
            let o = document.createElement('option'); o.value = v; o.innerText = v; s.appendChild(o);
        }
    },
    toggleManual() {
        const m = document.getElementById('manualCheck').checked;
        document.getElementById('manualRef').disabled = !m;
        document.getElementById('refSelect').disabled = m;
    },
    updateTsColor() {
        const col = document.getElementById('tsColorSelect').value;
        document.getElementById('pathAV').setAttribute('fill', col);
        document.getElementById('pathAR').setAttribute('fill', col);
    },
    updateLogoColor() {
        const col = document.getElementById('logoColorSelect').value;
        ['AV', 'AR'].forEach(s => {
            this.state.cans[s].getObjects('text').forEach(o => o.set('fill', col));
            this.state.cans[s].renderAll();
        });
    },
    triggerFile(side) {
        const val = document.getElementById('logo'+side).value;
        this.state.currentSide = side; 
        if(val === 'UPLOAD') {
            document.getElementById('fileInput').value = "";
            document.getElementById('fileInput').click();
        } else if(val !== "") {
            this.addText(side, val);
        }
    },
    handleFile(e) {
        const file = e.target.files[0]; if(!file) return;
        const side = this.state.currentSide;
        const fileType = file.type;
        const fileName = file.name.toLowerCase();

        // Gestion des PDFs
        if(fileType === 'application/pdf' || fileName.endsWith('.pdf')) {
            alert('üìÑ Fichier PDF s√©lectionn√©: ' + file.name + '\n\nLe PDF sera converti en image pour l\'aper√ßu.\nPour une meilleure qualit√©, exportez votre logo en PNG ou SVG.');
            // Pour les PDFs, on affiche un placeholder avec le nom du fichier
            const t = new fabric.Text('üìÑ ' + file.name.substring(0, 15) + (file.name.length > 15 ? '...' : ''), {
                fontSize: 14, fontWeight: '600', fill: '#666',
                left: 150, top: 150, originX: 'center', originY: 'center', padding: 25,
                backgroundColor: '#f5f5f5'
            });
            this.state.cans[side].add(t).setActiveObject(t);
            return;
        }

        // Gestion des images (JPG, PNG, GIF, SVG, WebP, BMP, TIFF)
        const reader = new FileReader();
        reader.onload = (event) => {
            fabric.Image.fromURL(event.target.result, (img) => {
                img.scaleToWidth(side === 'AV' ? 80 : 160);
                img.set({ left: 150, top: 180, originX: 'center', originY: 'center', padding: 25 });
                this.state.cans[side].add(img).setActiveObject(img);
            }, { crossOrigin: 'anonymous' });
        };
        reader.onerror = () => {
            alert('‚ùå Erreur lors de la lecture du fichier. Veuillez r√©essayer avec un autre format.');
        };
        reader.readAsDataURL(file);
    },
    addText(side, txt) {
        const t = new fabric.Text(txt, { fontSize: 35, fontWeight: '900', fill: document.getElementById('logoColorSelect').value, left: 150, top: 130, originX: 'center', originY: 'center', padding: 25 });
        this.state.cans[side].add(t).setActiveObject(t);
    },
    download() {
        ['AV', 'AR'].forEach(s => this.state.cans[s].discardActiveObject().renderAll());
        html2canvas(document.getElementById('capture'), { scale: 2 }).then(c => {
            const a = document.createElement('a');
            const ref = document.getElementById('manualCheck').checked ? document.getElementById('manualRef').value : document.getElementById('refSelect').value;
            a.download = `OLDA_${ref}.png`; a.href = c.toDataURL("image/png"); a.click();
        });
    }
};
window.onload = () => App.init();
</script>
</body>
</html>
